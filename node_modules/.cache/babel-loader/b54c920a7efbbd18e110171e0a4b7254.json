{"ast":null,"code":"import { DEFAULT_TIMEOUT } from '../lib/constants';\nexport default class Push {\n  /**\n   * Initializes the Push\n   *\n   * @param channel The Channel\n   * @param event The event, for example `\"phx_join\"`\n   * @param payload The payload, for example `{user_id: 123}`\n   * @param timeout The push timeout in milliseconds\n   */\n  constructor(channel, event, payload = {}, timeout = DEFAULT_TIMEOUT) {\n    this.channel = channel;\n    this.event = event;\n    this.payload = payload;\n    this.timeout = timeout;\n    this.sent = false;\n    this.timeoutTimer = undefined;\n    this.ref = '';\n    this.receivedResp = null;\n    this.recHooks = [];\n    this.refEvent = null;\n  }\n\n  resend(timeout) {\n    this.timeout = timeout;\n\n    this._cancelRefEvent();\n\n    this.ref = '';\n    this.refEvent = null;\n    this.receivedResp = null;\n    this.sent = false;\n    this.send();\n  }\n\n  send() {\n    if (this._hasReceived('timeout')) {\n      return;\n    }\n\n    this.startTimeout();\n    this.sent = true;\n    this.channel.socket.push({\n      topic: this.channel.topic,\n      event: this.event,\n      payload: this.payload,\n      ref: this.ref\n    });\n  }\n\n  updatePayload(payload) {\n    this.payload = Object.assign(Object.assign({}, this.payload), payload);\n  }\n\n  receive(status, callback) {\n    var _a;\n\n    if (this._hasReceived(status)) {\n      callback((_a = this.receivedResp) === null || _a === void 0 ? void 0 : _a.response);\n    }\n\n    this.recHooks.push({\n      status,\n      callback\n    });\n    return this;\n  }\n\n  startTimeout() {\n    if (this.timeoutTimer) {\n      return;\n    }\n\n    this.ref = this.channel.socket.makeRef();\n    this.refEvent = this.channel.replyEventName(this.ref);\n\n    const callback = payload => {\n      this._cancelRefEvent();\n\n      this._cancelTimeout();\n\n      this.receivedResp = payload;\n\n      this._matchReceive(payload);\n    };\n\n    this.channel.on(this.refEvent, callback);\n    this.timeoutTimer = setTimeout(() => {\n      this.trigger('timeout', {});\n    }, this.timeout);\n  }\n\n  trigger(status, response) {\n    if (this.refEvent) this.channel.trigger(this.refEvent, {\n      status,\n      response\n    });\n  }\n\n  destroy() {\n    this._cancelRefEvent();\n\n    this._cancelTimeout();\n  }\n\n  _cancelRefEvent() {\n    if (!this.refEvent) {\n      return;\n    }\n\n    this.channel.off(this.refEvent);\n  }\n\n  _cancelTimeout() {\n    clearTimeout(this.timeoutTimer);\n    this.timeoutTimer = undefined;\n  }\n\n  _matchReceive({\n    status,\n    response\n  }) {\n    this.recHooks.filter(h => h.status === status).forEach(h => h.callback(response));\n  }\n\n  _hasReceived(status) {\n    return this.receivedResp && this.receivedResp.status === status;\n  }\n\n}","map":{"version":3,"mappings":"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","names":["DEFAULT_TIMEOUT","Push","constructor","channel","event","payload","timeout","undefined","resend","_cancelRefEvent","ref","refEvent","receivedResp","sent","send","_hasReceived","startTimeout","socket","push","topic","updatePayload","Object","receive","status","callback","_a","response","recHooks","timeoutTimer","makeRef","replyEventName","_cancelTimeout","_matchReceive","on","setTimeout","trigger","destroy","off","clearTimeout","filter","h","forEach"],"sourceRoot":"","sources":["../../../src/lib/push.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}